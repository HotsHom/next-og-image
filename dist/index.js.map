{"version":3,"file":"index.js","sources":["../src/lib/get-base-url.ts","../src/lib/get-clean-path.ts","../src/lib/props-to-search-params.ts","../src/lib/get-image.ts","../src/lib/create-handler.ts"],"sourcesContent":["export default function getBaseUrl(): string | undefined {\r\n  if (process.env.OG_IMAGE_BASE_URL) {\r\n    return process.env.OG_IMAGE_BASE_URL\r\n  }\r\n\r\n  if (process.env.VERCEL_URL) {\r\n    return `https://${process.env.VERCEL_URL}`\r\n  }\r\n}\r\n","import { extname, basename } from 'path'\r\n\r\nexport default function getCleanPath(\r\n  path: string[],\r\n): {\r\n  path: string[]\r\n  extension: string\r\n} {\r\n  const cleanPath = [...path]\r\n  const finalElement = path[path.length - 1]\r\n  const extension = extname(finalElement)\r\n\r\n  cleanPath.splice(-1, 1, basename(finalElement, extension))\r\n\r\n  return {\r\n    path: cleanPath,\r\n    extension,\r\n  }\r\n}\r\n","import Props from '../types/props'\r\n\r\nexport default function propsToSearchParams(props: Props): URLSearchParams {\r\n  const searchParams = new URLSearchParams()\r\n\r\n  Object.entries(props).forEach(([propName, values]) => {\r\n    ;[].concat(values).forEach(value => {\r\n      searchParams.append(propName, value)\r\n    })\r\n  })\r\n\r\n  return searchParams\r\n}\r\n","import chrome from 'chrome-aws-lambda'\r\nimport puppeteer from 'puppeteer-core'\r\nimport Props from '../types/props'\r\nimport propsToSearchParams from './props-to-search-params'\r\n\r\nconst width = 1200\r\n\r\nexport default async function getImage(\r\n  baseUrl: string,\r\n  path: string[],\r\n  props: Props,\r\n): Promise<Buffer | String | void> {\r\n  const browser = await puppeteer.launch({\r\n    args: chrome.args,\r\n    executablePath:\r\n      process.env.OG_IMAGE_CHROME_EXECUTABLE_PATH ??\r\n      (await chrome.executablePath),\r\n  })\r\n\r\n  const page = await browser.newPage()\r\n  page.setViewport({ width, height: width / 2 })\r\n  await page.goto(\r\n    `${[baseUrl, ...path].join('/')}?${propsToSearchParams(props)}`,\r\n  )\r\n  const screenshot = await page.screenshot()\r\n  await browser.close()\r\n  return screenshot\r\n}\r\n","import { ServerResponse } from 'http'\r\nimport ApiRequest from '../types/api-request'\r\nimport getBaseUrl from './get-base-url'\r\nimport getCleanPath from './get-clean-path'\r\nimport getImage from './get-image'\r\n\r\nconst YEAR_SECONDS = 31536000\r\n\r\nexport default function createHandler(): (\r\n  req: ApiRequest,\r\n  res: ServerResponse,\r\n) => Promise<void> {\r\n  return async function handler(req, res) {\r\n    try {\r\n      const { path: rawPath, ...props } = req.query\r\n      const { path, extension } = getCleanPath(rawPath)\r\n      const baseUrl = getBaseUrl()\r\n\r\n      if (extension !== '.png') {\r\n        res.statusCode = 404\r\n        res.setHeader('Content-Type', 'text/html')\r\n        res.end('<h1>Not Found</h1>')\r\n        return\r\n      }\r\n\r\n      if (!baseUrl) {\r\n        throw new Error(\r\n          'No `OG_IMAGE_BASE_URL` or `VERCEL_URL` environment variable found.',\r\n        )\r\n      }\r\n\r\n      const image = await getImage(baseUrl, path, props)\r\n      res.statusCode = 200\r\n      res.setHeader('Content-Type', 'image/png')\r\n\r\n      res.setHeader(\r\n        'Cache-Control',\r\n        `public, immutable, no-transform, s-maxage=${YEAR_SECONDS}, max-age=${YEAR_SECONDS}`,\r\n      )\r\n\r\n      res.end(image)\r\n    } catch (error) {\r\n      res.setHeader('Content-Type', 'text/html')\r\n      res.end('<h1>Internal Error</h1><p>Sorry, there was a problem.</p>'+error)\r\n      console.error(error)\r\n    }\r\n  }\r\n}\r\n"],"names":["getBaseUrl","process","env","OG_IMAGE_BASE_URL","VERCEL_URL","getCleanPath","path","cleanPath","finalElement","length","extension","extname","splice","basename","propsToSearchParams","props","searchParams","URLSearchParams","Object","entries","forEach","propName","values","concat","value","append","width","getImage","baseUrl","browser","puppeteer","launch","args","chrome","executablePath","OG_IMAGE_CHROME_EXECUTABLE_PATH","page","newPage","setViewport","height","goto","join","screenshot","close","YEAR_SECONDS","createHandler","handler","req","res","rawPath","query","statusCode","setHeader","end","Error","image","error","console"],"mappings":"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"}